{{define "content"}}
<div class="container-fluid">
  <div>
    <div class="row ">
      <div class="col">
        <div class="d-flex">
          {{if gt (len .Exchanges) 0}}
          {{range $index, $exchange := .Exchanges}}
          <div class="">
            <form action="/finance" method="GET">
              <input type="hidden" name="selected_index" value="{{$index}}">
              <button type="submit"
                class="btn {{if eq $index $.SelectedIndex}}btn-warning{{else}}btn-secondary{{end}} mb-2">
                {{$exchange.Name}}
              </button>
            </form>
          </div>
          {{end}}
          {{else}}
          <p>No Exchanges</p>
          <button class="btn btn-sm btn-warning" type="">+</button>
          {{end}}
        </div>
        <!-- Navigation Tabs -->
        <ul class="nav nav-pills " id="finance-tabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="portfolio-tab" data-bs-toggle="pill" data-bs-target="#trade"
              type="button" role="tab">
              Trade
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button"
              role="tab">
              Orders
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="fills-tab" data-bs-toggle="pill" data-bs-target="#fills" type="button"
              role="tab">
              Fills
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="fills-tab" data-bs-toggle="pill" data-bs-target="#portfolio" type="button"
              role="tab">
              Portfolio
            </button>
          </li>
        </ul>
      </div>
      <div class="col">
        <!-- Watchlist Section -->
        <div class="row ">
          <div class="col">
            <h5>Watchlist:</h5>
            <div class="d-flex flex-wrap gap-2">
              {{range $index, $product := .SelectedExchange.Watchlist}}
              <form action="/finance" method="GET">
                <input type="hidden" name="selected_index" value="{{$.SelectedIndex}}">
                <input type="hidden" name="product_index" value="{{$index}}">
                <input type="hidden" name="timeframe_index" value="{{$.TimeframeIndex}}">
                <button type="submit"
                  class="btn btn-sm {{if eq $index $.ProductIndex}}btn-primary{{else}}btn-secondary{{end}}">
                  {{$product.ProductID}}
                </button>
              </form>
              {{end}}

              <!-- Add Product Dropdown -->
              <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle bg-dark" type="button" data-bs-toggle="dropdown">
                  +
                </button>
                <div class="dropdown-menu bg-dark p-2" style="width: 300px;">
                  <input type="text" class="form-control bg-dark text-white-50 mb-2" id="productSearch"
                    placeholder="Search products...">
                  <div class="dropdown-products">
                    {{range .SelectedExchange.AvailableProducts}}
                    <div class="dropdown-item bg-dark text-white-50 product-item">
                      <form action="/add-to-watchlist" method="POST">
                        <input type="hidden" name="xch_id" value="{{$.SelectedExchange.ID}}">
                        <input type="hidden" name="product_id" value="{{.ProductID}}">
                        <button type="submit" class="btn btn-sm btn-dark w-100 text-start">
                          {{.ProductID}} | {{.Volume_24h}}
                        </button>
                      </form>
                    </div>
                    {{end}}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col">
        <!-- Timeframes Section -->
        <div class="row ">
          <div class="col">
            <h5>Timeframes</h5>
            <div class="d-flex flex-wrap gap-2">
              {{range $index, $timeframe := .SelectedExchange.Timeframes}}
              <form action="/finance">
                <input type="hidden" name="selected_index" value="{{$.SelectedIndex}}">
                <input type="hidden" name="product_index" value="{{$.ProductIndex}}">
                <input type="hidden" name="timeframe_index" value="{{$index}}">
                <button type="submit"
                  class="btn btn-sm {{if eq $index $.TimeframeIndex}}btn-primary{{else}}btn-secondary{{end}}">
                  {{$timeframe.TF}}
                </button>
              </form>
              {{end}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- Tab Content -->
  <div class="tab-content" id="finance-tabContent">
    <!-- Trade Tab -->
    <div class="tab-pane fade show active" id="trade" role="tabpanel">
      <form action="/trade-entry" class="m-3 justify-content-between">
        <label for="entry">Entry</label>
        <input class="form-dark" type="text" name="entry" id="entry">
        <label for="amount">Amount</label>
        <input class="form-dark" type="text" name="amount" id="stoploss">
        <label for="stoploss">Stop Loss</label>
        <input class="form-dark" type="text" name="stoploss" id="stoploss">
        <label for="pt1">PT1</label>
        <input class="form-dark" type="text" name="pt1" id="pt1">
        <label for="pt2">PT2</label>
        <input class="form-dark" type="text" name="pt2" id="pt2">
        <button class="btn btn-sm btn-info">Submit</button>
      </form>
    </div>

    <!-- Orders Tab -->
    <div class="tab-pane fade" id="orders" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-dark table-striped">
          <thead>
            <tr>
              <th>Time</th>
              <th>Product</th>
              <th>Side</th>
              <th>Price</th>
              <th>Size</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {{range .SelectedExchange.Orders}}
            <tr>
              <td>{{.Timestamp}}</td>
              <td>{{.ProductID}}</td>
              <td>{{.Side}}</td>
              <td>{{.Price}}</td>
              <td>{{.Size}}</td>
              <td>{{.Status}}</td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Fills Tab -->
    <div class="tab-pane fade" id="fills" role="tabpanel">
      <div class="table-responsive">
        <table class="table table-dark table-striped">
          <thead>
            <tr>
              <th>Time</th>
              <th>Product</th>
              <th>Side</th>
              <th>Price</th>
              <th>Size</th>
              <th>Commission</th>
            </tr>
          </thead>
          <tbody>
            {{range .SelectedExchange.Fills}}
            <tr>
              <td>{{.Timestamp}}</td>
              <td>{{.ProductID}}</td>
              <td>{{.Side}}</td>
              <td>{{.Price}}</td>
              <td>{{.Size}}</td>
              <td>{{.Commission}}</td>
            </tr>
            {{end}}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Portfolio -->
    <div class="tab-pane fade" id="portfolio" role="tabpanel">
      <div class="d-flex">
        <div class="col-4">
          <h5>Total Value:</h5>
        </div>
        <div class="col-4">
          <table class="table table-striped table-dark">
            <thead>
              <tr>
                <th>Asset</th>
                <th>USD Value</th>
                <th>On-Hold</th>
              </tr>
            </thead>
            <tbody>
              {{range .SelectedExchange.Portfolio}}
              <tr>
                <td>{{.Asset}}</td>
                <td>{{.Value}}</td>
                <td>{{.Hold.Value}}</td>
              </tr>
              {{end}}
            </tbody>
          </table>
        </div>
        <div class="col-4">
          <h5>PieChart</h5>
        </div>
      </div>
    </div>
  </div>
  <div>
    <!-- Chart Section -->
    {{if .SelectedProduct.ProductID}}
    <div class="row">
      <div class="col">
        {{template "chart" .}}
      </div>
    </div>
    {{end}}
  </div>
</div>

<style>
  .dropdown-menu {
    margin: 0;
  }

  .dropdown-products {
    max-height: 300px;
    overflow-y: auto;
  }

  .dropdown-products::-webkit-scrollbar {
    width: 8px;
  }

  .dropdown-products::-webkit-scrollbar-track {
    background: #343a40;
  }

  .dropdown-products::-webkit-scrollbar-thumb {
    background: #666;
    border-radius: 4px;
  }

  .dropdown-products::-webkit-scrollbar-thumb:hover {
    background: #555;
  }

  .product-item:hover {
    background-color: #2c3034 !important;
    cursor: pointer;
  }

  .table-dark {
    background-color: #212529;
  }

  .nav-pills .nav-link {
    color: #fff;
  }

  .nav-pills .nav-link.active {
    background-color: #ffc107;
    color: #000;
  }

  .form-dark {
    background-color: #1a1a1a;
    border: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Product search functionality
    const searchInput = document.getElementById('productSearch');
    const productItems = document.querySelectorAll('.product-item');

    if (searchInput) {
      searchInput.addEventListener('input', function (e) {
        const searchTerm = e.target.value.toLowerCase().trim();

        // Debug logging
        console.log('Search term:', searchTerm);
        console.log('Number of product items:', productItems.length);

        productItems.forEach(item => {
          const text = item.textContent.toLowerCase();
          const display = text.includes(searchTerm) ? 'block' : 'none';
          item.style.display = display;

          // Debug logging
          console.log('Item text:', text, 'Display:', display);
        });
      });

      // Prevent dropdown from closing when clicking the search input
      searchInput.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
      });
    }

    // Keep dropdown open while filtering
    const dropdownMenu = document.querySelector('.dropdown-menu');
    if (dropdownMenu) {
      dropdownMenu.addEventListener('click', function (e) {
        e.stopPropagation();
      });
    }
  });
</script>
{{end}}